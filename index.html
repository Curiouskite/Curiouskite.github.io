<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Screenwriter Pro - Hex Edition</title>
    <style>
        :root {
            --bg-app: #ffffff;
            --bg-offset: #f8fafc;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --text-meta: #475569;
            --primary: #0f172a;
            --accent: #2563eb;
            --accent-light: #eff6ff;
            --border: #e2e8f0;
            --danger: #ef4444;
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-script: "Courier Prime", "Courier New", Courier, monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-ui);
            background: var(--bg-app);
            color: var(--text-main);
            height: 100dvh;
            overflow: hidden;
        }

        button, input, select, textarea { font: inherit; color: inherit; }

        /* === HEADER === */
        .header {
            background: var(--bg-app);
            border-bottom: 1px solid var(--border);
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            flex-shrink: 0;
            z-index: 20;
            gap: 12px;
        }

        .header-title-input {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
            border: 1px solid transparent;
            background: transparent;
            width: 100%;
            border-radius: 6px;
            padding: 4px 8px;
        }
        .header-title-input:focus { background: var(--bg-offset); border-color: var(--border); outline: none; }

        .header-actions { display: flex; gap: 8px; flex-shrink: 0; }

        .btn-header {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: white;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.15s, transform 0.1s;
        }
        .btn-header:hover { background: var(--bg-offset); }
        .btn-header:active { transform: scale(0.98); }
        .btn-header.danger { color: white; background: var(--danger); border-color: var(--danger); }
        .btn-header.danger:hover { background: #dc2626; }
        .btn-header.select-active { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-header.primary-btn { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-header.primary-btn:hover { background: #1d4ed8; }
        
        /* === HOME VIEW === */
        #viewHome { display: flex; flex-direction: column; height: 100%; background: var(--bg-offset); }

        .scene-list { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 100px; }

        .scene-card {
            background: var(--bg-app);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.15s, transform 0.1s;
        }
        .scene-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .scene-card:active { transform: scale(0.99); }
        .scene-card.selected { border: 2px solid var(--accent); background: var(--accent-light); }

        .scene-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .scene-info { flex: 1; }
        .scene-num { font-size: 0.7rem; color: var(--text-sub); font-weight: 700; margin-bottom: 4px; }
        .scene-name-card { font-weight: 700; font-size: 1rem; color: var(--primary); margin-bottom: 6px; }
        .scene-meta-card { font-size: 0.8rem; color: var(--text-sub); font-family: var(--font-script); }

        .btn-card-insert {
            width: 32px; height: 32px; border-radius: 50%;
            background: var(--bg-offset); border: 1px solid var(--border);
            color: var(--text-main); font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            margin-left: 12px; cursor: pointer; transition: background 0.15s;
        }
        .btn-card-insert:hover { background: var(--border); }

        .empty-create-btn {
            width: 100%; padding: 48px 24px;
            border: 2px dashed var(--border); border-radius: 12px;
            background: white; color: var(--text-sub);
            font-size: 1.15rem; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 12px;
        }

        /* === FAB & MENU === */
        .fab-btn {
            position: fixed; bottom: 32px; right: 24px;
            width: 56px; height: 56px;
            background: var(--primary); color: white;
            border: none; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 14px rgba(0,0,0,0.25);
            cursor: pointer; z-index: 50;
            transition: transform 0.1s;
        }
        .fab-btn:active { transform: scale(0.95); }

        #dropUpMenu {
            position: fixed; bottom: 100px; right: 24px;
            width: 200px; background: white;
            border: 1px solid var(--border); border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none; flex-direction: column; z-index: 51;
            max-height: 300px; overflow-y: auto;
        }
        #dropUpMenu.visible { display: flex; }

        .menu-item {
            padding: 12px 16px; font-weight: 600; font-size: 0.95rem;
            border-bottom: 1px solid var(--border); cursor: pointer;
            display: flex; align-items: center; gap: 10px;
        }
        .menu-item:last-child { border-bottom: none; }
        .menu-item.special { background: var(--accent-light); color: var(--accent); border-bottom: 2px solid var(--border); }

        /* === SHOWCASE / READ VIEW === */
        #viewShowcase { display: none; flex-direction: column; height: 100%; background: var(--bg-app); }

        .script-content {
            flex: 1; overflow-y: auto;
            padding: 24px 24px 120px;
        }

        .scene-header-block {
            margin-bottom: 32px; padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center;
        }

        .main-title { font-size: 1.5rem; font-weight: 800; color: var(--primary); margin-bottom: 12px; text-align: center; }

        .stamps-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; justify-content: center; }
        .stamp {
            background: var(--bg-offset); color: var(--text-sub);
            padding: 4px 10px; border-radius: 6px;
            font-size: 0.78rem; font-weight: 600;
            font-family: var(--font-script); border: 1px solid var(--border);
        }

        /* === META STACK === */
        #metaStack {
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            display: none;
            flex-direction: column;
            padding: 12px 16px 16px 16px;
            gap: 10px;
            animation: slideDown 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #metaStack.visible { display: flex; }

        .tier-1 { border-bottom: 1px solid #e2e8f0; padding-bottom: 6px; margin-bottom: 2px; }
        .tier-grid { display: grid; gap: 10px; }
        .tier-2 { grid-template-columns: 2fr 1fr 1fr; }
        .tier-3 { grid-template-columns: 1fr 1fr 1fr; }

        .input-heading {
            width: 100%; background: transparent; border: none;
            font-family: var(--font-script); font-weight: 700;
            font-size: 1.15rem; color: var(--primary); outline: none; padding: 4px 0;
        }

        .meta-cell {
            background: white; border: 1px solid var(--border);
            border-radius: 6px; padding: 4px 8px;
            display: flex; flex-direction: column; position: relative;
        }
        .meta-label { font-size: 0.6rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 2px; }
        .meta-select {
            appearance: none; border: none; background: transparent;
            font-size: 0.85rem; font-weight: 600; color: var(--primary);
            width: 100%; outline: none; padding: 0; cursor: pointer;
            font-family: var(--font-ui); padding-right: 14px;
        }
        .btn-cell-gear {
            position: absolute; right: 2px; top: 2px;
            font-size: 0.7rem; color: #cbd5e1; cursor: pointer;
            background: none; border: none; padding: 4px; z-index: 5;
        }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* === EDITOR ROWS === */
        .editor-row {
            margin-bottom: 24px;
            font-family: var(--font-script);
            font-size: 1.05rem;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .editor-label-col {
            width: 100%;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .editor-label {
            font-weight: 700;
            user-select: none;
            cursor: pointer;
            font-size: 0.95em;
            text-transform: uppercase;
        }

        .btn-bubble-toggle {
            cursor: pointer;
            background: transparent;
            border: none;
            width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            color: #cbd5e1;
            transition: all 0.2s;
            border-radius: 4px;
            margin-left: 8px;
        }
        .btn-bubble-toggle svg { width: 18px; height: 18px; fill: currentColor; }
        .btn-bubble-toggle:hover { background: #f1f5f9; color: var(--text-meta); }
        .btn-bubble-toggle.is-open { color: var(--accent); background: #eff6ff; }
        .btn-bubble-toggle.has-content:not(.is-open) { color: var(--text-meta); }

        .editor-input-col {
            width: 100%;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* Thought Box */
        .editor-thought-container {
            display: none;
            margin-bottom: 12px;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .editor-thought-container.visible { display: block; }

        .thought-box {
            background: linear-gradient(145deg, #eff6ff 0%, #dbeafe 100%);
            border-radius: 18px;
            border: 1px solid #bfdbfe;
            padding: 12px 16px;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.1), inset 0 1px 2px #ffffff;
            position: relative;
        }

        .editor-thought-input {
            width: 100%;
            display: block;
            background: transparent;
            border: none;
            outline: none;
            font-family: var(--font-script);
            font-size: 1.05rem; 
            line-height: 1.6;   
            color: #2563eb; 
            font-style: normal; 
            resize: none;
        }
        .editor-thought-input:empty::before { content: 'Internal subtext...'; opacity: 0.5; font-style: italic; }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.95) translateY(-5px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Main Input */
        .editor-input {
            outline: none;
            color: var(--primary);
            white-space: pre-wrap;
            word-break: break-word;
            min-height: 1.6em;
            border: 1px solid transparent;
            display: block;
            width: 100%;
            padding-left: 16px; 
            padding-right: 16px;
        }
        .editor-input:focus { background: linear-gradient(90deg, var(--bg-offset) 0%, transparent 100%); }
        .editor-input.is-action { font-style: italic; color: var(--text-main); }

        /* === MODALS === */
        #assetModal, #parserModal, #confirmModal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; 
            align-items: center; justify-content: center;
        }
        
        /* FIX: Color picker higher Z-Index to show above asset modal */
        #colorPickerModal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300; 
            align-items: center; justify-content: center;
        }

        .asset-card {
            background: white; width: 90%; max-width: 420px; border-radius: 12px; 
            padding: 20px; display: flex; flex-direction: column; max-height: 82vh;
            animation: modalIn 0.2s ease-out;
        }
        
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .parser-textarea {
            width: 100%; height: 200px; border: 1px solid var(--border); border-radius: 8px; padding: 12px;
            font-family: var(--font-script); font-size: 0.9rem; resize: none; margin-bottom: 12px;
        }
        .parser-textarea:focus { border-color: var(--accent); outline: none; }

        .asset-list { flex: 1; overflow-y: auto; margin-bottom: 16px; }
        .asset-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); align-items: center; }
        .asset-item:last-child { border-bottom: none; }
        .asset-item-left { display: flex; align-items: center; flex: 1; }
        .asset-val { flex: 1; font-weight: 500; cursor: pointer; margin-right: 8px; padding: 4px; border-radius: 4px; transition: background 0.1s; }
        .btn-del-asset { color: var(--danger); font-size: 1.4rem; background:none; border:none; cursor:pointer; }
        .char-dot-manage { width: 16px; height: 16px; border-radius: 50%; margin-right: 12px; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); }
        
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; padding: 12px 0; margin-bottom: 12px; }
        .color-swatch { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); margin: 0 auto; transition: transform 0.1s; }
        .color-swatch:hover { transform: scale(1.1); }
        
        .custom-color-row { 
            display: flex; gap: 12px; align-items: center; 
            border-top: 1px solid var(--border); padding-top: 16px; margin-top: 4px;
        }
        .hex-wrapper { display: flex; align-items: center; gap: 8px; flex: 1; background: var(--bg-offset); padding: 4px 8px; border-radius: 8px; border: 1px solid var(--border); }
        .input-hex { border: none; background: transparent; width: 100%; outline: none; font-family: monospace; text-transform: uppercase; letter-spacing: 1px; }

        .asset-empty { text-align: center; padding: 24px; color: var(--text-sub); font-style: italic; }
        .confirm-text { margin-bottom: 20px; font-size: 1rem; line-height: 1.5; }
        .confirm-buttons { display: flex; gap: 10px; }
        .confirm-buttons .btn-header { flex: 1; justify-content: center; }
        .input-std { width: 100%; height: 42px; border: 1px solid var(--border); border-radius: 8px; padding: 0 12px; }
    </style>
<base target="_blank">
</head>
<body>

<input type="file" id="importFile" accept=".txt" style="display:none">

<div id="viewHome">
    <div class="header">
        <input id="projectTitle" type="text" class="header-title-input" value="My Script" maxlength="80" aria-label="Project Title">
        <div class="header-actions" id="headerActions">
            <button class="btn-header" onclick="document.getElementById('importFile').click()">Import</button>
            <button class="btn-header" onclick="exportScript()">Export</button>
            <button class="btn-header" id="btnSelect" onclick="toggleSelectionMode()">Select</button>
        </div>
        <div class="header-actions" id="selectionActions" style="display:none">
            <button class="btn-header danger" onclick="deleteSelected()">Delete</button>
            <button class="btn-header" onclick="toggleSelectionMode()">Cancel</button>
        </div>
    </div>
    <div id="sceneList" class="scene-list"></div>
</div>

<div id="viewShowcase">
    <div class="header">
        <button class="btn-header" onclick="navHome()">‚Üê Back</button>
        <div id="displaySceneNum" style="flex:1; text-align:center; font-weight:700; color:var(--primary); white-space:nowrap; overflow:hidden;">SCENE 1</div>
        <div class="header-actions">
            <button class="btn-header" onclick="copySceneToClipboard()">Copy</button>
            <button class="btn-header" onclick="toggleStack()">Info üåê</button>
            <button class="btn-header danger" onclick="confirmDeleteScene()">üßû</button>
        </div>
    </div>

    <div id="metaStack">
        <div class="tier-1">
            <span class="meta-label">Scene Heading</span>
            <input id="inName" type="text" class="input-heading" placeholder="SCENE HEADING..." onblur="saveMeta()">
        </div>
        <div class="tier-grid tier-2">
            <div class="meta-cell">
                <span class="meta-label">Location</span>
                <select id="inLoc" class="meta-select" onchange="saveMeta()"></select>
                <button class="btn-cell-gear" onclick="manageAssets('loc', 'Locations')">‚öô</button>
            </div>
            <div class="meta-cell">
                <span class="meta-label">Time</span>
                <select id="inTime" class="meta-select" onchange="saveMeta()"></select>
                <button class="btn-cell-gear" onclick="manageAssets('time', 'Times')">‚öô</button>
            </div>
            <div class="meta-cell">
                <span class="meta-label">Day</span>
                <select id="inDay" class="meta-select" onchange="saveMeta()"></select>
                <button class="btn-cell-gear" onclick="manageAssets('day', 'Days')">‚öô</button>
            </div>
        </div>
        <div class="tier-grid tier-3">
            <div class="meta-cell">
                <span class="meta-label">Clock</span>
                <select id="inClock" class="meta-select" onchange="saveMeta()"></select>
                <button class="btn-cell-gear" onclick="manageAssets('clock', 'Clock')">‚öô</button>
            </div>
            <div class="meta-cell">
                <span class="meta-label">Month</span>
                <select id="inMonth" class="meta-select" onchange="saveMeta()"></select>
                <button class="btn-cell-gear" onclick="manageAssets('month', 'Months')">‚öô</button>
            </div>
            <div class="meta-cell">
                <span class="meta-label">Year</span>
                <select id="inYear" class="meta-select" onchange="saveMeta()"></select>
                <button class="btn-cell-gear" onclick="manageAssets('year', 'Years')">‚öô</button>
            </div>
        </div>
    </div>

    <div id="scriptContent" class="script-content">
        <div class="scene-header-block">
            <div id="displayTitle" class="main-title">Untitled Scene</div>
            <div class="stamps-row">
                <div id="stampLoc" class="stamp"></div>
                <div id="stampTime" class="stamp"></div>
                <div id="stampDay" class="stamp"></div>
                <div id="stampClock" class="stamp"></div>
                <div id="stampMonth" class="stamp"></div>
                <div id="stampYear" class="stamp"></div>
            </div>
        </div>
        <div id="scriptBody"></div>
    </div>

    <div id="dropUpMenu">
        <div id="menuListContent"></div>
    </div>
    <button id="starBtn" class="fab-btn" onclick="toggleDropUp()">+</button>
</div>

<div id="assetModal" onclick="if(event.target===this) closeAssetManager()">
    <div class="asset-card">
        <div id="assetTitle" style="font-weight:700; margin-bottom:4px;">Manage</div>
        <div style="font-size:0.82rem; color:var(--text-sub); margin-bottom:16px;">...</div>
        <div id="assetList" class="asset-list"></div>
        <div class="asset-add-row" style="display:flex; gap:8px;">
            <input id="newAssetInput" type="text" class="input-std" placeholder="new..." maxlength="40" onkeypress="if(event.key==='Enter')addNewAsset()">
            <button class="btn-header" style="background:var(--primary); color:white;" onclick="addNewAsset()">+</button>
        </div>
        <button class="btn-header" style="margin-top:12px; justify-content:center;" onclick="closeAssetManager()">Done</button>
    </div>
</div>

<div id="colorPickerModal" onclick="if(event.target===this) closeColorPicker()">
    <div class="asset-card">
        <div style="font-weight:700; text-align:center; margin-bottom:16px;">Select Color</div>
        
        <div id="colorGrid" class="color-grid"></div>
        
        <div class="custom-color-row">
            <input type="color" id="nativePicker" onchange="syncHexInput(this.value)" style="width:40px; height:40px; border:none; cursor:pointer; flex-shrink:0;">
            
            <div class="hex-wrapper">
                <span style="color:var(--text-sub); font-size:0.9rem;">#</span>
                <input type="text" id="hexTextInput" class="input-hex" placeholder="RRGGBB" maxlength="6" oninput="syncNativePicker(this.value)">
            </div>
            
            <button class="btn-header primary-btn" onclick="applyCustomHex()">Set</button>
            <button class="btn-header" onclick="closeColorPicker()">Cancel</button>
        </div>
    </div>
</div>

<div id="parserModal" onclick="if(event.target===this) closeParserModal()">
    <div class="asset-card">
        <div style="font-weight:700; margin-bottom:4px;">Parser</div>
        <div style="font-size:0.82rem; color:var(--text-sub); margin-bottom:16px;">Paste format: "JOE: (Thinking) Speaking"</div>
        <textarea id="parserInput" class="parser-textarea" placeholder="Joe: (I am tired) Hello world...&#10;Action: The door opens...&#10;MARY: Hi there!"></textarea>
        <div style="display:flex; gap:8px;">
            <button class="btn-header danger" style="flex:1; justify-content:center;" onclick="closeParserModal()">Cancel</button>
            <button class="btn-header" style="flex:1; justify-content:center; background:var(--primary); color:white;" onclick="processParserInput()">Parse</button>
        </div>
    </div>
</div>

<div id="confirmModal" onclick="if(event.target===this) closeConfirmModal()">
    <div class="asset-card">
        <div id="confirmTitle" style="font-weight:700; margin-bottom:4px;">Confirm</div>
        <div id="confirmMessage" class="confirm-text">Are you sure?</div>
        <div class="confirm-buttons">
            <button class="btn-header" onclick="closeConfirmModal()">Cancel</button>
            <button id="confirmAction" class="btn-header danger">Confirm</button>
        </div>
    </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CONFIG
const KEY = 'screenwriter_pro_v3_jelly'; 
const DIVIDER = "==================================================";
const CHAR_COLORS = ["#2563eb","#dc2626","#16a34a","#d97706","#9333ea","#0891b2","#be123c","#4f46e5","#b45309","#059669","#334155","#57534e","#7c3aed","#c026d3","#db2777"];

let data = {
    title: "My Script",
    scenes: [],
    assets: {
        loc: ["INT. HOUSE", "EXT. STREET"],
        time: ["DAY", "NIGHT"],
        month: ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"],
        year: ["2025", "2026", "2027"],
        day: ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY", "SUNDAY"],
        clock: ["09:00 AM", "12:00 PM", "03:00 PM", "06:00 PM"],
        chars: ["HERO", "VILLAIN"],
        charColors: {} 
    }
};

let curSceneIdx = -1;
let currentManageKey = '';
let isSelectionMode = false;
let selectedIndices = new Set();
let lastFocusedIndex = -1;
let targetColorChar = '';
let longPressTimer = null;
let isLongPress = false;
let exportUrl = null;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ INIT & SAVE
function init() {
    document.getElementById('importFile').addEventListener('change', importScript);
    document.getElementById('projectTitle').addEventListener('blur', save);
    document.getElementById('projectTitle').addEventListener('input', function() { data.title = this.value.trim(); });
    
    const stored = localStorage.getItem(KEY);
    if (stored) { 
        try { 
            const parsed = JSON.parse(stored);
            data = { ...data, ...parsed };
            if (!data.assets) data.assets = {};
            ['loc', 'time', 'month', 'year', 'day', 'clock', 'chars'].forEach(k => {
                if (!data.assets[k]) data.assets[k] = [];
            });
            if (!data.assets.charColors) data.assets.charColors = {};
        } catch(e) { console.error('Failed to load data:', e); } 
    }
    
    document.getElementById('projectTitle').value = data.title;
    renderHome();
    initColorGrid();
    
    document.addEventListener('click', (e) => {
        const menu = document.getElementById('dropUpMenu');
        const btn = document.getElementById('starBtn');
        if (!menu.contains(e.target) && !btn.contains(e.target)) menu.classList.remove('visible');
    });
    
    document.addEventListener('keydown', handleKeydown);
}

function save() {
    data.title = document.getElementById('projectTitle').value.trim();
    try { localStorage.setItem(KEY, JSON.stringify(data)); } catch(e) { alert('Storage full.'); }
}

function handleKeydown(e) {
    if (e.key === 'Escape') {
        closeAllModals();
        if (document.getElementById('dropUpMenu').classList.contains('visible')) document.getElementById('dropUpMenu').classList.remove('visible');
    }
}

function closeAllModals() {
    document.getElementById('assetModal').style.display = 'none';
    document.getElementById('colorPickerModal').style.display = 'none';
    document.getElementById('parserModal').style.display = 'none';
    document.getElementById('confirmModal').style.display = 'none';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ HOME & NAV
function renderHome() {
    const list = document.getElementById('sceneList');
    list.innerHTML = '';
    if (data.scenes.length === 0) {
        list.innerHTML = `<div class="empty-create-btn" onclick="createNewSceneAtEnd()">+ Create First Scene</div>`;
        return;
    }
    data.scenes.forEach((s, i) => {
        const card = document.createElement('div');
        card.className = `scene-card ${isSelectionMode && selectedIndices.has(i) ? 'selected' : ''}`;
        card.onclick = (e) => {
            if (isSelectionMode) { e.stopPropagation(); toggleSelection(i); } else openShowcase(i);
        };
        const title = s.name?.trim() || `Scene ${i+1}`;
        let meta = [s.loc, s.time].filter(Boolean).join(" ‚Ä¢ ") || "No details";
        let btn = !isSelectionMode ? `<button class="btn-card-insert" onclick="event.stopPropagation(); insertScene(${i})" title="Insert scene after">+</button>` : '';
        card.innerHTML = `<div class="scene-header"><div class="scene-info"><div class="scene-num">SCENE ${i + 1}</div><div class="scene-name-card">${escapeHtml(title)}</div><div class="scene-meta-card">${escapeHtml(meta)}</div></div>${btn}</div>`;
        list.appendChild(card);
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function toggleSelectionMode() {
    isSelectionMode = !isSelectionMode;
    selectedIndices.clear();
    document.getElementById('headerActions').style.display = isSelectionMode ? 'none' : 'flex';
    document.getElementById('selectionActions').style.display = isSelectionMode ? 'flex' : 'none';
    document.getElementById('btnSelect').classList.toggle('select-active', isSelectionMode);
    renderHome();
}

function toggleSelection(i) {
    if (selectedIndices.has(i)) selectedIndices.delete(i); else selectedIndices.add(i);
    renderHome();
}

function deleteSelected() {
    if (selectedIndices.size === 0) return;
    showConfirm(`Delete ${selectedIndices.size} scene(s)?`, () => {
        const sorted = [...selectedIndices].sort((a,b)=>b-a);
        sorted.forEach(idx => data.scenes.splice(idx,1));
        save(); toggleSelectionMode();
    });
}

function createNewSceneAtEnd() {
    const prev = data.scenes.at(-1) || {};
    data.scenes.push({ loc: prev.loc||"", time: prev.time||"", month: prev.month||"", year: prev.year||"", day: prev.day||"", clock: prev.clock||"", name: "", lines: [] });
    save(); openShowcase(data.scenes.length - 1);
}

function insertScene(idx) {
    if (idx < 0 || idx >= data.scenes.length) idx = data.scenes.length - 1;
    const prev = data.scenes[idx] || {};
    data.scenes.splice(idx + 1, 0, { loc: prev.loc||"", time: prev.time||"", month: prev.month||"", year: prev.year||"", day: prev.day||"", clock: prev.clock||"", name: "", lines: [] });
    save(); openShowcase(idx + 1);
}

function confirmDeleteScene() {
    showConfirm("Delete this scene?", () => {
        data.scenes.splice(curSceneIdx, 1);
        save(); navHome();
    });
}

function navHome() {
    document.getElementById('viewShowcase').style.display = 'none';
    document.getElementById('viewHome').style.display = 'flex';
    curSceneIdx = -1;
    lastFocusedIndex = -1;
    renderHome();
}

function openShowcase(idx) {
    if (idx < 0 || idx >= data.scenes.length) return;
    curSceneIdx = idx;
    const s = data.scenes[idx];
    document.getElementById('viewHome').style.display = 'none';
    document.getElementById('viewShowcase').style.display = 'flex';
    document.getElementById('inName').value = s.name || '';
    refreshDropdowns(s);
    lastFocusedIndex = (s.lines && s.lines.length > 0) ? s.lines.length - 1 : -1;
    renderContent();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ EDITOR CORE
function renderContent() {
    const s = data.scenes[curSceneIdx];
    if (!s) return;
    document.getElementById('displaySceneNum').textContent = `SCENE ${curSceneIdx + 1}`;
    document.getElementById('displayTitle').textContent = s.name || "Untitled Scene";
    
    ['loc','time','month','year','day','clock'].forEach(k => {
        const el = document.getElementById('stamp' + k.charAt(0).toUpperCase() + k.slice(1));
        if (el) {
            el.textContent = s[k] || ''; 
            el.style.display = s[k] ? 'inline-block' : 'none';
        }
    });

    const body = document.getElementById('scriptBody');
    body.innerHTML = '';
    (s.lines || []).forEach((l, i) => body.appendChild(createEditorRow(l, i)));
}

function createEditorRow(lineObj, index) {
    const row = document.createElement('div');
    row.className = 'editor-row';

    const leftCol = document.createElement('div');
    leftCol.className = 'editor-label-col';
    
    if (lineObj.c !== 'AUTHOR') {
        const color = getColorForName(lineObj.c);
        const label = document.createElement('span');
        label.className = 'editor-label';
        label.textContent = lineObj.c;
        label.style.color = color;
        attachLongPress(label, index);
        leftCol.appendChild(label);

        const bubble = document.createElement('button');
        bubble.innerHTML = `<svg viewBox="0 0 24 24"><path d="M10 4a1 1 0 0 0-2 0 10 10 0 0 0 0 20 1 1 0 0 0 2 0 8 8 0 0 1 0-16zm4 0a1 1 0 0 0 0 16 8 8 0 0 1 0-16 1 1 0 0 0 2 0 10 10 0 0 0 0 20 1 1 0 0 0 0-20z"/></svg>`;
        bubble.className = 'btn-bubble-toggle';
        
        const hasThought = (lineObj.th && lineObj.th.trim().length > 0);
        if (hasThought) bubble.classList.add('has-content');

        bubble.onclick = (e) => {
            e.stopPropagation();
            const thoughtBox = row.querySelector('.editor-thought-container');
            if (thoughtBox.classList.contains('visible')) {
                thoughtBox.classList.remove('visible');
                bubble.classList.remove('is-open');
                if (lineObj.th && lineObj.th.trim().length > 0) bubble.classList.add('has-content');
                else bubble.classList.remove('has-content');
            } else {
                thoughtBox.classList.add('visible');
                bubble.classList.add('is-open');
                const input = row.querySelector('.editor-thought-input');
                if (input) input.focus();
            }
        };
        leftCol.appendChild(bubble);
    } else {
        const label = document.createElement('span');
        label.className = 'editor-label';
        label.textContent = "Author";
        label.style.color = "#94a3b8";
        attachLongPress(label, index);
        leftCol.appendChild(label);
    }
    row.appendChild(leftCol);

    const rightCol = document.createElement('div');
    rightCol.className = 'editor-input-col';

    const thoughtContainer = document.createElement('div');
    thoughtContainer.className = 'editor-thought-container';
    const thoughtBox = document.createElement('div');
    thoughtBox.className = 'thought-box';
    const thoughtInput = document.createElement('span');
    thoughtInput.className = 'editor-thought-input';
    thoughtInput.contentEditable = "true";
    thoughtInput.textContent = lineObj.th || "";
    
    thoughtInput.onfocus = () => { lastFocusedIndex = index; };
    thoughtInput.oninput = () => { 
        lineObj.th = thoughtInput.innerText; 
        save(); 
        const bubble = row.querySelector('.btn-bubble-toggle');
        if (bubble) {
            if (lineObj.th && lineObj.th.trim().length > 0) bubble.classList.add('has-content');
            else bubble.classList.remove('has-content');
        }
    };
    
    thoughtBox.appendChild(thoughtInput);
    thoughtContainer.appendChild(thoughtBox);
    rightCol.appendChild(thoughtContainer);

    const dialogInput = document.createElement('span');
    dialogInput.className = 'editor-input';
    if (lineObj.c === 'AUTHOR') dialogInput.classList.add('is-action');
    dialogInput.contentEditable = "true";
    dialogInput.textContent = lineObj.t || "";
    dialogInput.onfocus = () => { lastFocusedIndex = index; };
    dialogInput.oninput = () => { lineObj.t = dialogInput.innerText; save(); };

    rightCol.appendChild(dialogInput);
    row.appendChild(rightCol);
    return row;
}

function attachLongPress(el, index) {
    const start = (e) => {
        isLongPress = false;
        longPressTimer = setTimeout(() => { isLongPress = true; confirmDeleteLine(index); }, 600);
    };
    const end = () => { if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; } };
    el.addEventListener('touchstart', start, {passive: true});
    el.addEventListener('touchend', end);
    el.addEventListener('mousedown', start);
    el.addEventListener('mouseup', end);
    el.addEventListener('click', (e) => { if (isLongPress) { e.preventDefault(); e.stopPropagation(); isLongPress = false; } });
}

function confirmDeleteLine(index) {
    if (confirm("Delete this block?")) {
        data.scenes[curSceneIdx].lines.splice(index, 1);
        save(); renderContent(); lastFocusedIndex = -1;
    }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MENU & ASSETS
function toggleDropUp() {
    const m = document.getElementById('dropUpMenu');
    if (m.classList.contains('visible')) m.classList.remove('visible'); else { renderMenu(); m.classList.add('visible'); }
}

function renderMenu() {
    const c = document.getElementById('menuListContent');
    let html = `<div class="menu-item special" onclick="openParserModal();toggleDropUp()">üìã Parser</div>`;
    html += `<div class="menu-item" onclick="insertLine('AUTHOR')">‚úçÔ∏è Action/Author</div>`;
    if (data.assets.chars.length === 0) {
        html += `<div class="menu-item" style="color:var(--text-sub); font-style:italic;">No characters yet</div>`;
    } else {
        data.assets.chars.forEach(ch => {
            html += `<div class="menu-item" onclick="insertLine('${escapeJs(ch)}')"><span style="color:${getColorForName(ch)}">‚óè</span> ${escapeHtml(ch)}</div>`;
        });
    }
    html += `<div class="menu-item" style="border-top:1px solid #eee; margin-top:8px; padding-top:12px;" onclick="manageAssets('chars','Name list');toggleDropUp()">‚öôÔ∏è Manage Characters</div>`;
    c.innerHTML = html;
}

function escapeJs(str) { return str.replace(/'/g, "\\'").replace(/"/g, '\\"'); }
function openParserModal() { document.getElementById('parserModal').style.display = 'flex'; document.getElementById('parserInput').focus(); }
function closeParserModal() { document.getElementById('parserModal').style.display = 'none'; }

function insertLine(name) {
    const s = data.scenes[curSceneIdx];
    if (!s) return;
    const insertIndex = (lastFocusedIndex >= 0 && lastFocusedIndex < s.lines.length) ? lastFocusedIndex + 1 : s.lines.length;
    s.lines.splice(insertIndex, 0, { c: name, t: "", th: "" });
    save(); renderContent(); toggleDropUp();
    setTimeout(() => {
        const rows = document.getElementById('scriptBody').children;
        if (rows[insertIndex]) {
            rows[insertIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            if (name === 'AUTHOR') rows[insertIndex].querySelector('.editor-input').focus();
            else {
                rows[insertIndex].querySelector('.editor-thought-container').classList.add('visible');
                rows[insertIndex].querySelector('.btn-bubble-toggle').classList.add('is-open');
                rows[insertIndex].querySelector('.editor-thought-input').focus();
            }
            lastFocusedIndex = insertIndex;
        }
    }, 50);
}

function initColorGrid() {
    const grid = document.getElementById('colorGrid');
    grid.innerHTML = '';
    CHAR_COLORS.forEach(color => {
        const s = document.createElement('div');
        s.className = 'color-swatch'; s.style.backgroundColor = color;
        s.onclick = () => applyCharColor(color); grid.appendChild(s);
    });
}
function getColorForName(name) {
    if (!name) return CHAR_COLORS[0];
    if (data.assets.charColors[name]) return data.assets.charColors[name];
    let hash = 0; for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
    return CHAR_COLORS[Math.abs(hash) % CHAR_COLORS.length];
}

/* === COLOR PICKER & HEX LOGIC === */
function openColorPicker(charName) {
    targetColorChar = charName;
    const curColor = getColorForName(charName);
    
    // Set visual picker
    document.getElementById('nativePicker').value = curColor;
    
    // Set text input (remove #)
    document.getElementById('hexTextInput').value = curColor.replace('#', '').toUpperCase();
    
    document.getElementById('colorPickerModal').style.display = 'flex';
}

function closeColorPicker() {
    document.getElementById('colorPickerModal').style.display = 'none';
    targetColorChar = '';
}

function syncHexInput(val) {
    document.getElementById('hexTextInput').value = val.replace('#', '').toUpperCase();
}

function syncNativePicker(val) {
    // Only update visual picker if valid hex
    if (/^[0-9A-F]{6}$/i.test(val)) {
        document.getElementById('nativePicker').value = '#' + val;
    }
}

function applyCustomHex() {
    let hex = document.getElementById('hexTextInput').value.trim();
    if (!hex.startsWith('#')) hex = '#' + hex;
    
    // Simple validation
    if (/^#[0-9A-F]{6}$/i.test(hex)) {
        applyCharColor(hex);
    } else {
        alert("Invalid Hex Code (Use RRGGBB format)");
    }
}

function applyCharColor(val) {
    if (!targetColorChar) return;
    data.assets.charColors[targetColorChar] = val;
    save(); 
    closeColorPicker(); 
    renderContent();
    if (document.getElementById('assetModal').style.display === 'flex') renderAssetList();
}
/* ================================= */

function manageAssets(k, title) {
    currentManageKey = k;
    document.getElementById('assetTitle').textContent = title;
    document.getElementById('assetModal').style.display = 'flex';
    document.getElementById('newAssetInput').value = '';
    renderAssetList();
}
function closeAssetManager() { document.getElementById('assetModal').style.display = 'none'; currentManageKey = ''; }
function renderAssetList() {
    const list = document.getElementById('assetList');
    list.innerHTML = '';
    const items = data.assets[currentManageKey] || [];
    if (items.length === 0) { list.innerHTML = `<div class="asset-empty">No items yet.</div>`; return; }
    items.forEach((v, i) => {
        const div = document.createElement('div'); div.className = 'asset-item';
        let left = `<div class="asset-item-left">`;
        // UPDATED: Now calls openColorPicker instead of inline JS
        if (currentManageKey === 'chars') left += `<span class="char-dot-manage" style="background:${getColorForName(v)}" onclick="event.stopPropagation(); openColorPicker('${escapeJs(v)}')"></span>`;
        left += `<span class="asset-val" onclick="renameAsset(${i})">${escapeHtml(v)}</span></div>`;
        div.innerHTML = left + `<button class="btn-del-asset" onclick="delAsset(${i})">-</button>`;
        list.appendChild(div);
    });
}
function addNewAsset() {
    const v = document.getElementById('newAssetInput').value.trim().toUpperCase();
    if (v && !data.assets[currentManageKey].includes(v)) {
        data.assets[currentManageKey].push(v); save(); renderAssetList();
        document.getElementById('newAssetInput').value = '';
    }
}
function delAsset(i) {
    const item = data.assets[currentManageKey][i];
    if(confirm(`Remove "${item}"?`)) { data.assets[currentManageKey].splice(i, 1); save(); renderAssetList(); }
}
function renameAsset(i) {
    const old = data.assets[currentManageKey][i];
    const n = prompt("Rename:", old);
    if (n) {
        const trim = n.trim().toUpperCase();
        if (trim && trim !== old && !data.assets[currentManageKey].includes(trim)) {
            data.assets[currentManageKey][i] = trim;
            if (currentManageKey === 'chars') {
                data.scenes.forEach(s => s.lines.forEach(l => { if (l.c === old) l.c = trim; }));
                if (data.assets.charColors[old]) { data.assets.charColors[trim] = data.assets.charColors[old]; delete data.assets.charColors[old]; }
            }
            save(); renderAssetList(); renderContent();
        }
    }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ META UI
function refreshDropdowns(s) {
    ['loc', 'time', 'month', 'year', 'day', 'clock'].forEach(k => {
        const el = document.getElementById('in' + k.charAt(0).toUpperCase() + k.slice(1));
        const assets = data.assets[k] || [];
        el.innerHTML = '<option value="">Select...</option>' + 
            assets.map(o => `<option value="${escapeHtml(o)}" ${o === s[k] ? 'selected' : ''}>${escapeHtml(o)}</option>`).join('');
    });
}
function saveMeta() {
    const s = data.scenes[curSceneIdx];
    if (!s) return;
    s.name = document.getElementById('inName').value.trim();
    ['loc', 'time', 'month', 'year', 'day', 'clock'].forEach(k => {
        s[k] = document.getElementById('in' + k.charAt(0).toUpperCase() + k.slice(1)).value;
    });
    save(); renderContent();
}
function toggleStack() { document.getElementById('metaStack').classList.toggle('visible'); }

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CONFIRM
function showConfirm(msg, cb) {
    document.getElementById('confirmMessage').textContent = msg;
    document.getElementById('confirmAction').onclick = () => { closeConfirmModal(); if(cb) cb(); };
    document.getElementById('confirmModal').style.display = 'flex';
}
function closeConfirmModal() { document.getElementById('confirmModal').style.display = 'none'; }

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PARSER / EXPORT
function processParserInput() {
    const inputField = document.getElementById('parserInput');
    const txt = inputField.value;
    
    if (!txt.trim()) return;

    const s = data.scenes[curSceneIdx];

    txt.split(/\r?\n/).forEach(l => {
        l = l.trim();
        if (!l) return;
        const idx = l.indexOf(':');
        if (idx === -1) {
            const clean = l.replace(/^[^a-zA-Z]+/, '');
            if (clean) s.lines.push({ c: 'AUTHOR', t: clean });
        } else {
            let rawName = l.substring(0, idx);
            let name = rawName.replace(/^[^a-zA-Z]+/, '').trim().toUpperCase();
            let text = l.substring(idx + 1).trim();
            let th = "";
            if (text.startsWith('(')) {
                let end = text.indexOf(')');
                if (end > -1) {
                    th = text.substring(1, end);
                    text = text.substring(end + 1).trim();
                }
            }
            if (name === 'ACTION' || name === 'AUTHOR') {
                if (text) s.lines.push({ c: 'AUTHOR', t: text });
            } else {
                if (name) {
                    if (!data.assets.chars.includes(name)) data.assets.chars.push(name);
                    s.lines.push({ c: name, t: text, th: th });
                }
            }
        }
    });

    save();
    renderContent();
    inputField.value = '';
    closeParserModal();
}

function copySceneToClipboard() {
    const s = data.scenes[curSceneIdx];
    let txt = `SCENE ${curSceneIdx + 1}\nNAME: ${s.name||''}\n\n`;
    s.lines.forEach(l => {
        if (l.c === 'AUTHOR') txt += `AUTHOR: ${l.t}\n\n`;
        else txt += `${l.c}: ${l.th ? '('+l.th+') ' : ''}${l.t}\n\n`;
    });
    navigator.clipboard.writeText(txt).then(() => showToast("Copied!")).catch(() => alert('Failed'));
}
function showToast(msg) {
    const t = document.createElement('div'); t.textContent = msg;
    t.style.cssText = 'position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--primary);color:white;padding:12px 24px;border-radius:8px;z-index:300;font-weight:600;';
    document.body.appendChild(t); setTimeout(() => t.remove(), 2000);
}

function exportScript() {
    let txt = `TITLE: ${data.title.toUpperCase()}\n\n`;

    data.scenes.forEach((s, i) => {
        // 1. Build the Scene Header
        let headerLine = `SCENE ${i+1}`;
        if (s.name) headerLine += `: ${s.name.toUpperCase()}`;
        
        let slugLine = [s.loc, s.time].filter(Boolean).join(' - ');
        
        let extraInfo = [s.day, s.month, s.year, s.clock].filter(Boolean).join(' | ');
        if (extraInfo) extraInfo = `(${extraInfo})`;

        txt += `${headerLine}\n`;
        if (slugLine) txt += `${slugLine}\n`;
        if (extraInfo) txt += `${extraInfo}\n`;
        txt += `\n`; 

        // 2. Build the Script Body
        s.lines.forEach(l => {
            if (l.c === 'AUTHOR') {
                txt += `${l.t}\n\n`;
            } else {
                // Character
                txt += `${l.c.toUpperCase()}\n`;
                // Thought
                if (l.th && l.th.trim()) {
                    txt += `(${l.th})\n`;
                }
                // Dialogue
                txt += `${l.t}\n\n`;
            }
        });

        // 3. Separator
        txt += `\n${DIVIDER}\n\n`;
    });

    // Generate Download
    if (exportUrl) URL.revokeObjectURL(exportUrl);
    const blob = new Blob([txt], { type: 'text/plain' });
    exportUrl = URL.createObjectURL(blob);
    const a = document.createElement('a'); 
    a.href = exportUrl; 
    a.download = (data.title || 'script').replace(/\W/g, '_') + '.txt';
    document.body.appendChild(a); 
    a.click(); 
    a.remove();
}

function importScript(e) {
    const f = e.target.files?.[0]; if (!f) return;
    showConfirm('Import will REPLACE data. Continue?', () => {
        const r = new FileReader();
        r.onload = ev => {
            try {
                data.scenes = [];
                const chunks = ev.target.result.split(DIVIDER).slice(1);
                chunks.forEach(c => {
                    let sc = { loc:"", time:"", month:"", year:"", day:"", clock:"", name:"", lines:[] };
                    c.split('\n').forEach(l => {
                        let t = l.trim();
                        if (t.startsWith('NAME:')) sc.name = t.substring(5).trim();
                        else if (t.startsWith('DETAILS:')) {
                            const m = t.match(/\[(.*?):(.*?)\]/g);
                            if (m) m.forEach(x => {
                                let [k, v] = x.replace(/[\[\]]/g, '').split(':');
                                if (sc.hasOwnProperty(k.toLowerCase())) sc[k.toLowerCase()] = v || '';
                            });
                        } else if (t.includes(':')) {
                            let idx = t.indexOf(':');
                            let char = t.substring(0, idx).trim();
                            let content = t.substring(idx+1).trim();
                            let th = "";
                            if (content.startsWith('(')) { let end = content.indexOf(')'); if (end>-1) { th=content.substring(1,end); content=content.substring(end+1).trim(); } }
                            if (char === 'AUTHOR') sc.lines.push({ c: 'AUTHOR', t: content });
                            else if (!['TITLE','SCENE','NAME','DETAILS'].includes(char)) {
                                if (!data.assets.chars.includes(char)) data.assets.chars.push(char);
                                sc.lines.push({ c: char, t: content, th: th });
                            }
                        }
                    });
                    if (sc.lines.length>0 || sc.name) data.scenes.push(sc);
                });
                save(); renderHome(); showToast(`Imported ${data.scenes.length} scenes`);
            } catch (err) { alert('Import failed.'); }
            e.target.value = '';
        };
        r.readAsText(f);
    });
}

init();
</script>
</body>
</html>
